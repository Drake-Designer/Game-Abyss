{% extends "base.html" %}
{% load static %}
{% load cloudinary_extras %}
{% block title %}
  Blog - Game Abyss
{% endblock title %}
{% block content %}
  <section class="container py-4">
    <!-- Toolbar -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="page-blog-index__title mb-0">
        <i class="fas fa-wave-square me-2 text-primary"></i>Echoes from the Abyss
      </h1>
    </div>
    {% if posts %}
      <div class="row g-4">
        {% for post in posts %}
          <div class="col-md-6 col-lg-4">
            <article class="comp-card h-100" aria-labelledby="post-{{ post.pk }}-title">
              {% if post.image %}
                <div class="comp-card__image-wrap">
                  <picture>
                    <source media="(max-width: 991.98px)"
                            srcset="{{ post.image.url|cloudinary_variant:'f_auto,q_auto,c_fill,g_auto:subject,ar_4:3,w_900' }}">
                    <source media="(min-width: 992px)"
                            srcset="{{ post.image.url|cloudinary_variant:'f_auto,q_auto,c_fill,g_auto:subject,ar_16:9,w_1200' }}">
                    <img class="comp-card__image"
                         src="{{ post.image.url|cloudinary_variant:'f_auto,q_auto,c_fill,g_auto:subject,ar_16:9,w_1200' }}"
                         alt="{{ post.title }}"
                         width="1200"
                         height="675"
                         loading="lazy" />
                  </picture>
                </div>
              {% endif %}
              <div class="comp-card__body d-flex flex-column">
                <h3 id="post-{{ post.pk }}-title"
                    class="comp-card__title h5 d-flex align-items-center gap-2">
                  <a class="util-no-decoration" href="{{ post.get_absolute_url }}">{{ post.title }}</a>
                  {% if post.featured %}
                    <span class="comp-badge comp-badge--featured d-inline-flex align-items-center gap-1">
                      <i class="fas fa-star"></i> Featured
                    </span>
                  {% endif %}
                </h3>
                <!-- META: autore e data su due righe -->
                <div class="page-blog-index__meta mb-2">
                  <div class="d-flex align-items-center gap-1 mb-1">
                    <i class="fas fa-user-astronaut"></i>
                    {% with post.author as post_author %}
                      <span class="comp-user-label {% if post_author.is_superuser %}comp-user-label--legendary{% elif post_author.is_staff %}comp-user-label--epic{% else %}comp-user-label--common{% endif %}">
                        <span class="comp-user-label__name">{{ post_author }}</span>
                      </span>
                    {% endwith %}
                  </div>
                  <time datetime="{{ post.published_at|default:post.updated_at|date:'c' }}"
                        class="d-flex align-items-center gap-1">
                    <i class="fas fa-calendar-alt"></i>
                    {{ post.published_at|default:post.updated_at|date:"F j, Y" }}
                  </time>
                </div>
                <p class="page-blog-index__excerpt mb-3">
                  {% if post.excerpt %}
                    {{ post.excerpt }}
                  {% else %}
                    {{ post.body|striptags|truncatechars:140 }}
                  {% endif %}
                </p>
                {% if post.tags.all %}
                  <ul class="list-unstyled d-flex flex-wrap gap-2 mb-3">
                    {% for tag in post.tags.all %}
                      <li>
                        <a href="{% url 'blog:index' %}?tag={{ tag.slug }}"
                           class="badge rounded-pill text-decoration-none comp-tag-badge">
                          <i class="fas fa-hashtag me-1"></i>{{ tag.name }}
                        </a>
                      </li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <span class="page-blog-index__tags--empty small"></span>
                {% endif %}
                <div class="mt-auto d-flex justify-content-between align-items-center">
                  <a class="comp-button comp-button--primary"
                     href="{{ post.get_absolute_url }}">
                    <i class="fas fa-book-open me-2"></i>Read
                  </a>
                  {% if post.read_time %}
                    <span class="small d-inline-flex align-items-center gap-1 opacity-75">
                      <i class="fas fa-hourglass-half"></i> {{ post.read_time }} min
                    </span>
                  {% endif %}
                </div>
              </div>
            </article>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <h3 class="mb-2">
          <i class="fas fa-moon me-2 text-secondary"></i>The Abyss is quiet
        </h3>
        <p class="text-muted mb-4">No echoes yet. Launch the first post and light up the void.</p>
        <a href="{% url 'blog:new' %}" class="comp-button comp-button--primary">
          <i class="fas fa-satellite-dish me-2"></i>Start a Transmission
        </a>
      </div>
    {% endif %}
  </section>
{% endblock content %}
